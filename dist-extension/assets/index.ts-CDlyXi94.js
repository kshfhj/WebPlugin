console.log("ğŸ›¡ï¸ Web Security Guardian Background Service Starting...");let r={enabled:!0,maliciousUrlProtection:!0,xssProtection:!0,trackerBlocking:!0,formProtection:!0,phishingProtection:!0,notifications:!0,autoUpdate:!0,strictMode:!1};async function h(){try{const t=await chrome.declarativeNetRequest.getEnabledRulesets();console.log("ğŸ“‹ å½“å‰å¯ç”¨çš„è§„åˆ™é›†:",t);const o=[];r.enabled&&(r.maliciousUrlProtection&&o.push("malicious_urls"),r.trackerBlocking&&o.push("tracker_blocking"));const e=t.filter(a=>!o.includes(a)),c=o.filter(a=>!t.includes(a));e.length>0||c.length>0?(await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:e,enableRulesetIds:c}),console.log("âœ… è§„åˆ™é›†å·²æ›´æ–°:",{å·²å¯ç”¨:o,å·²ç¦ç”¨:e,æ–°å¯ç”¨:c})):console.log("â„¹ï¸ è§„åˆ™é›†æ— éœ€æ›´æ–°")}catch(t){console.error("âŒ æ›´æ–°è§„åˆ™é›†å¤±è´¥:",t)}}chrome.storage.local.get(["protection_settings"],async t=>{t.protection_settings&&(r={...r,...t.protection_settings},console.log("âœ… Protection settings loaded:",r)),await h()});chrome.storage.onChanged.addListener(async(t,o)=>{o==="local"&&t.protection_settings&&(r=t.protection_settings.newValue,console.log("âš™ï¸ Protection settings updated:",r),await h())});class d{maliciousUrls=new Set(["malware-example.com","phishing-test.net","suspicious-site.org","fake-bank.com","scam-lottery.net","malware-download.com","virus-test.org","trojan-horse.net","ransomware-test.com","spyware-domain.org","paypal-verify.com","apple-security.net","microsoft-update.org","amazon-account.com","google-verify.net","facebook-security.com","netflix-payment.net","bank-verify.org","free-money.com","win-prize.net","get-rich-quick.org","bitcoin-doubler.com","lottery-winner.net","inheritance-claim.org","exploit-kit.invalid","evil-domain.test","malicious-ads.test"]);trackerDomains=new Set(["google-analytics.com","googletagmanager.com","facebook.com","doubleclick.net","googlesyndication.com","amazon-adsystem.com","connect.facebook.net","www.google-analytics.com","analytics.google.com","stats.g.doubleclick.net","googleads.g.doubleclick.net"]);isMalicious(o){try{const e=new URL(o),c=e.hostname.toLowerCase(),a=e.pathname.toLowerCase(),u=o.toLowerCase();if(this.maliciousUrls.has(c))return!0;for(const i of this.maliciousUrls)if(c===i||c.endsWith("."+i))return!0;const s=[/paypal.*verify/i,/paypal.*secure/i,/paypal.*account/i,/amazon.*verify/i,/amazon.*account/i,/google.*verify/i,/google.*security/i,/microsoft.*update/i,/microsoft.*security/i,/apple.*security/i,/facebook.*security/i,/netflix.*payment/i,/bank.*verify/i,/secure.*login/i,/account.*suspended/i,/verify.*identity/i,/update.*payment/i,/confirm.*account/i,/bitcoin.*doubler/i,/free.*money/i,/win.*prize/i,/lottery.*winner/i];for(const i of s)if(i.test(c)||i.test(u))return console.log("ğŸ£ æ£€æµ‹åˆ°é’“é±¼æ¨¡å¼:",i,"URL:",o),!0;const l=["/malware","/virus","/trojan","/exploit","/payload","/ransomware","/keylogger","/backdoor"];for(const i of l)if(a.includes(i))return console.log("ğŸš¨ æ£€æµ‹åˆ°å¯ç–‘è·¯å¾„:",i,"URL:",o),!0;const n=[".exe",".scr",".bat",".cmd",".vbs",".js",".jar",".apk"];for(const i of n)if(a.endsWith(i))return console.log("ğŸ“¦ æ£€æµ‹åˆ°å¯ç–‘æ–‡ä»¶ç±»å‹:",i,"URL:",o),!0;return!1}catch{return!1}}isTracker(o){try{const e=new URL(o).hostname.toLowerCase();return Array.from(this.trackerDomains).some(c=>e===c||e.endsWith("."+c))}catch{return!1}}async isInBlacklist(o){try{const e=new URL(o).hostname.toLowerCase();return((await chrome.storage.local.get(["blacklist"])).blacklist||[]).some(u=>e===u||e.endsWith("."+u))}catch{return!1}}async isInWhitelist(o){try{const e=new URL(o).hostname.toLowerCase();return((await chrome.storage.local.get(["whitelist"])).whitelist||[]).some(u=>e===u||e.endsWith("."+u))}catch{return!1}}async checkUrlSecurity(o){return await this.isInWhitelist(o)?{isSafe:!0,reason:"åœ¨ç™½åå•ä¸­",level:"safe"}:await this.isInBlacklist(o)?{isSafe:!1,reason:"åœ¨ç”¨æˆ·é»‘åå•ä¸­",level:"danger"}:this.isMalicious(o)?{isSafe:!1,reason:"æ£€æµ‹åˆ°æ¶æ„URL",level:"danger"}:this.isTracker(o)?{isSafe:!1,reason:"æ£€æµ‹åˆ°è¿½è¸ªå™¨",level:"warning"}:{isSafe:!0,reason:"æœªæ£€æµ‹åˆ°å¨èƒ",level:"safe"}}}const g=new d;chrome.runtime.onInstalled.addListener(async t=>{console.log("âœ… Extension installed:",t.reason),t.reason==="install"?(await chrome.storage.local.set({protection_settings:{enabled:!0,maliciousUrlProtection:!0,xssProtection:!0,trackerBlocking:!0,formProtection:!0,phishingProtection:!0,notifications:!0,autoUpdate:!0,strictMode:!1},security_stats:{totalThreats:0,blockedThreats:0,allowedThreats:0,threatsByType:{malicious_url:0,xss_attack:0,tracker:0,insecure_form:0,suspicious_script:0,phishing:0},threatsByLevel:{low:0,medium:0,high:0,critical:0},lastScanTime:0},whitelist:[],blacklist:[]}),await h(),chrome.tabs.create({url:chrome.runtime.getURL("src/options/index.html")})):t.reason==="update"&&await h()});chrome.webRequest.onBeforeRequest.addListener(t=>{r.enabled&&(r.maliciousUrlProtection&&g.isMalicious(t.url)&&(console.log("ğŸš« Malicious URL detected (blocked by declarativeNetRequest):",t.url),chrome.storage.local.get(["security_stats"],o=>{if(o.security_stats){const e=o.security_stats;e.totalThreats++,e.blockedThreats++,e.threatsByType.malicious_url++,e.threatsByLevel.high++,chrome.storage.local.set({security_stats:e})}}),r.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon.svg"),title:"ğŸš« æ¶æ„URLå·²é˜»æ­¢",message:`å·²æ‹¦æˆªæ¶æ„ç½‘ç«™: ${new URL(t.url).hostname}`,priority:2})),r.trackerBlocking&&g.isTracker(t.url)&&(console.log("ğŸ‘ï¸ Tracker request detected (blocked by declarativeNetRequest):",t.url),chrome.storage.local.get(["security_stats"],o=>{if(o.security_stats){const e=o.security_stats;e.totalThreats++,e.blockedThreats++,e.threatsByType.tracker++,e.threatsByLevel.medium++,chrome.storage.local.set({security_stats:e})}})))},{urls:["<all_urls>"]});chrome.runtime.onMessage.addListener((t,o,e)=>{console.log("ğŸ“¨ Received message:",t.type);try{switch(t.type){case"GET_SECURITY_STATUS":return chrome.storage.local.get(["security_stats"],s=>{e({maliciousUrlsCount:s.security_stats?.blockedThreats||0,trackersBlocked:s.security_stats?.threatsByType?.tracker||0})}),!0;case"GET_STATS":return chrome.storage.local.get(["security_stats"],s=>{e(s.security_stats||{totalThreats:0,blockedThreats:0,allowedThreats:0,threatsByType:{},threatsByLevel:{},lastScanTime:Date.now()})}),!0;case"UPDATE_SETTINGS":return chrome.storage.local.set({protection_settings:t.data},async()=>{r=t.data,console.log("âœ… Settings saved and applied:",r),await h(),e({success:!0})}),!0;case"GET_SETTINGS":return chrome.storage.local.get(["protection_settings"],s=>{e(s.protection_settings||r)}),!0;case"SETTINGS_UPDATED":console.log("âš™ï¸ Settings updated:",t.data),r=t.data,e({success:!0});break;case"TOGGLE_PROTECTION":console.log("ğŸ”„ Protection toggled:",t.data),e({success:!0});break;case"SCAN_PAGE":console.log("ğŸ” Scanning page:",t.data?.tabId),e({success:!0});break;case"PAGE_NAVIGATION":console.log("ğŸ”„ Page navigation detected, clearing previous threats for:",t.url);let c="";try{c=new URL(t.url).hostname}catch{c=t.url}return chrome.storage.local.get(["threat_history"],s=>{const l=s.threat_history||[],n=l.filter(i=>{try{return new URL(i.url).hostname!==c}catch{return!i.url.includes(c)}});console.log(`ğŸ—‘ï¸ Cleared ${l.length-n.length} threats for ${c}`),chrome.storage.local.set({threat_history:n},()=>{e({success:!0,clearedCount:l.length-n.length})})}),!0;case"THREAT_DETECTED":if(console.log("ğŸš¨ Threat detected:",t.threat||t.data),!r.enabled){console.log("â¸ï¸ Protection disabled, threat not recorded"),e({success:!1,reason:"protection_disabled"});break}const a=t.threat||t.data;if(!(()=>{switch(a.type){case"malicious_url":return r.maliciousUrlProtection;case"xss_attack":return r.xssProtection;case"tracker":return r.trackerBlocking;case"insecure_form":return r.formProtection;case"phishing":return r.phishingProtection;case"suspicious_script":return r.xssProtection;default:return!0}})()){console.log(`â­ï¸ Threat type ${a.type} protection is disabled`),e({success:!1,reason:"feature_disabled"});break}chrome.storage.local.get(["security_stats","threat_history"],s=>{const l=s.security_stats||{totalThreats:0,blockedThreats:0,allowedThreats:0,threatsByType:{malicious_url:0,xss_attack:0,sql_injection:0,tracker:0,insecure_form:0,suspicious_script:0,phishing:0,data_leak:0},threatsByLevel:{low:0,medium:0,high:0,critical:0},lastScanTime:Date.now()};l.totalThreats++,a.blocked?l.blockedThreats++:l.allowedThreats++,l.threatsByType[a.type]!==void 0&&l.threatsByType[a.type]++,l.threatsByLevel[a.level]!==void 0&&l.threatsByLevel[a.level]++,l.lastScanTime=Date.now();const n=s.threat_history||[];if(n.unshift(a),n.length>100&&n.splice(100),chrome.storage.local.set({security_stats:l,threat_history:n}),console.log("ğŸ“Š Stats updated:",l),r.notifications&&a.blocked){const i={malicious_url:"æ¶æ„URL",xss_attack:"XSSæ”»å‡»",tracker:"è¿½è¸ªå™¨",insecure_form:"ä¸å®‰å…¨è¡¨å•",phishing:"é’“é±¼ç½‘ç«™",suspicious_script:"å¯ç–‘è„šæœ¬"};chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon.svg"),title:`ğŸ›¡ï¸ å·²é˜»æ­¢${i[a.type]||"å¨èƒ"}`,message:a.description||`æ£€æµ‹åˆ°${i[a.type]}`,priority:a.level==="critical"||a.level==="high"?2:1})}}),e({success:!0});break;case"SECURITY_ISSUE":console.log("âš ï¸ Security issue:",t.issueType,t.data),e({success:!0});break;case"UPDATE_WHITELIST":return console.log("ğŸ“ Updating whitelist:",t.data),chrome.storage.local.set({whitelist:t.data},()=>{console.log("âœ… Whitelist updated successfully"),e({success:!0})}),!0;case"GET_WHITELIST":return chrome.storage.local.get(["whitelist"],s=>{console.log("ğŸ“‹ Getting whitelist:",s.whitelist),e({whitelist:s.whitelist||[]})}),!0;case"UPDATE_BLACKLIST":return console.log("ğŸ“ Updating blacklist:",t.data),chrome.storage.local.set({blacklist:t.data},()=>{console.log("âœ… Blacklist updated successfully"),e({success:!0})}),!0;case"GET_BLACKLIST":return chrome.storage.local.get(["blacklist"],s=>{console.log("ğŸ“‹ Getting blacklist:",s.blacklist),e({blacklist:s.blacklist||[]})}),!0;case"CHECK_URL":return console.log("ğŸ” Checking URL:",t.url),g.checkUrlSecurity(t.url).then(s=>{console.log("ğŸ“Š URLæ£€æŸ¥ç»“æœ:",s),e(s)}).catch(s=>{console.error("âŒ URLæ£€æŸ¥å¤±è´¥:",s),e({isSafe:!0,reason:"æ£€æŸ¥å¤±è´¥",level:"safe"})}),!0;case"PING":console.log("ğŸ“ Received PING from content script"),e({success:!0,message:"pong"});break;case"GET_RULES_STATUS":return chrome.declarativeNetRequest.getEnabledRulesets().then(s=>{console.log("ğŸ“‹ å½“å‰å¯ç”¨çš„è§„åˆ™é›†:",s),e({enabledRulesets:s,settings:r})}).catch(s=>{console.error("âŒ è·å–è§„åˆ™çŠ¶æ€å¤±è´¥:",s),e({error:String(s)})}),!0;default:e({success:!0})}}catch(c){console.error("âŒ Error handling message:",c),e({error:String(c)})}return!0});chrome.tabs.onUpdated.addListener((t,o,e)=>{o.status==="complete"&&e.url&&(console.log("ğŸ“„ Page loaded:",e.url),r.enabled&&r.maliciousUrlProtection&&g.isMalicious(e.url)&&(console.log("âš ï¸ Warning: Potentially malicious page"),r.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon.svg"),title:"âš ï¸ è­¦å‘Šï¼šå¯ç–‘ç½‘ç«™",message:`æ‚¨æ­£åœ¨è®¿é—®å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©çš„ç½‘ç«™: ${new URL(e.url).hostname}`,priority:2})))});chrome.webRequest.onHeadersReceived.addListener(t=>{console.log("ğŸ” Headers received from:",t.url)},{urls:["<all_urls>"]});console.log("âœ… Web Security Guardian Background Service Started Successfully");let m=0;setInterval(()=>{m++,console.log(`ğŸ’“ Service Worker heartbeat #${m}`)},3e4);
